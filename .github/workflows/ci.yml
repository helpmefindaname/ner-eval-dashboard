name: 'Run tests for ci cd'
on:
  push:
    branches: [ main ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    branches: [ main ]

env:
  is_package: true
  publish_docker: true

jobs:
  test-docker:
    runs-on: ubuntu-latest
    env:
      tag: "docker-${{ github.sha }}:latest"
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build docker image
        uses: docker/build-push-action@v4
        id: docker-build
        with:
            context: .
            load: true
            push: false
            build-args: |
               BUILD=test
            cache-from: type=gha
            cache-to: type=gha,mode=max
            tags: ${{env.tag}}
      - name: run tests in docker
        uses: addnab/docker-run-action@v3
        with:
          shell: bash
          image: ${{env.tag}}
          run: pytest -vv
  prep-vars:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-vars.outputs.matrix }}
      publish_docker: ${{ steps.set-vars.outputs.publish_docker }}
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - id: set-vars
        run: |
          echo ::set-output name=matrix::{\"python-version\":${{ env.is_package && '[ \"3.8\", \"3.9\", \"3.10\" ]' || '[ \"3.10\" ]' }} }
          echo ::set-output name=publish_docker::${{env.publish_docker}}
  test:
    runs-on: ubuntu-latest
    needs: prep-vars
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.prep-vars.outputs.matrix)}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: setup python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: '**/requirements*.txt'
      - name: Install dependencies
        run: pip install --upgrade -r requirements.txt
      - name: Install dev dependencies
        run: pip install --upgrade -r requirements-dev.txt
      - name: Install package
        run: pip install -e . --no-deps
      - name: show dependencies
        run: pip freeze
      - name: Run tests including flake8 and mypy, etc.
        run: pytest -vv
  build-n-publish:
    name: Build and publish Python ðŸ distributions ðŸ“¦ to PyPI
    runs-on: ubuntu-latest
    needs: [test, test-docker]
    if: startsWith(github.ref, 'refs/tags')
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'
      - name: Install pypa/build
        run: pip install build --user
      - name: Build a binary wheel and a source tarball
        run: python -m build --sdist --wheel --outdir dist/
      - name: Publish distribution ðŸ“¦ to PyPI
        if: ${{env.is_package}}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
  publish-docker:
    name: Publish docker file and push it to a registry
    runs-on: ubuntu-latest
    needs: [test, test-docker, prep-vars]
    if: needs.prep-vars.outputs.publish_docker && startsWith(github.ref, 'refs/tags')
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Save tag name
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: |
            buildx-
      - name: Build and push
        uses: docker/build-push-action@v3
        with:
          context: .
          cache-from: type=local,src=/tmp/.buildx-cache
          push: true
          tags: |
            helpmefindaname/ner-eval-dashboard:${{ env.RELEASE_VERSION }}
            helpmefindaname/ner-eval-dashboard:latest